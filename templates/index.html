<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Live MCP Test - Web Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
        }
        .output-container {
            background: #1e1e1e;
            color: #fff;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .output-line {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .output-line:last-child {
            border-bottom: none;
        }
        .output-line.stdout {
            color: #4CAF50;
        }
        .output-line.stderr {
            color: #f44336;
        }
        .output-line.system {
            color: #2196F3;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-running {
            background: #ff9800;
            color: white;
        }
        .status-completed {
            background: #4CAF50;
            color: white;
        }
        .status-error {
            background: #f44336;
            color: white;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 10px 30px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-danger {
            border-radius: 25px;
            padding: 10px 30px;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .title {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .execution-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="connection-status">
        <span id="connection-status" class="badge bg-secondary">
            <i class="fas fa-circle"></i> 連接中...
        </span>
    </div>

    <div class="container mt-5">
        <div class="title">
            <h1><i class="fas fa-rocket"></i> Space Live MCP Test</h1>
            <p class="lead">Gemini CLI Web Interface</p>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="card-title">
                            <i class="fas fa-terminal"></i> 命令輸入
                        </h5>
                        
                        <div class="input-group">
                            <input type="text" id="userInput" class="form-control" 
                                   placeholder="輸入您的指令..." 
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" id="executeBtn" onclick="executeCommand()">
                                <i class="fas fa-play"></i> 執行
                            </button>
                            <button class="btn btn-danger" id="stopBtn" onclick="stopExecution()" style="display: none;">
                                <i class="fas fa-stop"></i> 停止
                            </button>
                        </div>

                        <div id="executionInfo" class="execution-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <span id="executionStatus" class="status-badge status-running">
                                    <span class="spinner"></span> 執行中...
                                </span>
                                <small id="executionTime" class="text-muted"></small>
                            </div>
                            <div class="mt-2">
                                <strong>輸入:</strong> <span id="executionInput"></span>
                            </div>
                            <div class="mt-1">
                                <strong>命令:</strong> <span id="executionCommand"></span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button class="btn btn-outline-light btn-sm" onclick="clearOutput()">
                                <i class="fas fa-trash"></i> 清除輸出
                            </button>
                            <a href="/history" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-history"></i> 執行歷史
                            </a>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h5 class="card-title">
                            <i class="fas fa-desktop"></i> 即時輸出
                        </h5>
                        
                        <div id="outputContainer" class="output-container p-3">
                            <div class="output-line system">
                                <i class="fas fa-info-circle"></i> 等待指令輸入...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // WebSocket 連接
        const socket = io();
        
        let currentExecutionId = null;
        let isExecuting = false;

        // 連接狀態管理
        socket.on('connect', function() {
            updateConnectionStatus('connected', 'bg-success');
            addSystemMessage('WebSocket 連接成功');
        });

        socket.on('disconnect', function() {
            updateConnectionStatus('連接中斷', 'bg-danger');
            addSystemMessage('WebSocket 連接中斷');
        });

        socket.on('connected', function(data) {
            addSystemMessage(data.message);
        });

        // 執行相關事件
        socket.on('execution_started', function(data) {
            currentExecutionId = data.id;
            isExecuting = true;
            
            // 更新執行信息
            document.getElementById('executionInfo').style.display = 'block';
            document.getElementById('executionInput').textContent = data.user_input;
            document.getElementById('executionTime').textContent = data.timestamp;
            document.getElementById('executionStatus').className = 'status-badge status-running';
            document.getElementById('executionStatus').innerHTML = '<span class="spinner"></span> 執行中...';
            
            // 禁用執行按鈕，顯示停止按鈕
            document.getElementById('executeBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // 清除之前的輸出
            clearOutput();
            addSystemMessage(`🚀 開始執行 (ID: ${data.id})`);
        });

        socket.on('execution_progress', function(data) {
            if (data.id === currentExecutionId) {
                document.getElementById('executionCommand').textContent = data.message;
                addSystemMessage(data.message);
            }
        });

        socket.on('execution_output', function(data) {
            if (data.id === currentExecutionId) {
                addOutputLine(data.line, data.type);
            }
        });

        socket.on('execution_completed', function(data) {
            if (data.id === currentExecutionId) {
                isExecuting = false;
                
                // 更新狀態
                const statusEl = document.getElementById('executionStatus');
                if (data.success) {
                    statusEl.className = 'status-badge status-completed';
                    statusEl.innerHTML = '<i class="fas fa-check"></i> 完成';
                    addSystemMessage(`✅ 執行完成 (返回碼: ${data.return_code})`);
                } else {
                    statusEl.className = 'status-badge status-error';
                    statusEl.innerHTML = '<i class="fas fa-times"></i> 失敗';
                    addSystemMessage(`❌ 執行失敗 (返回碼: ${data.return_code})`);
                }
                
                // 重新啟用執行按鈕，隱藏停止按鈕
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                currentExecutionId = null;
            }
        });

        socket.on('execution_error', function(data) {
            if (data.id === currentExecutionId) {
                isExecuting = false;
                
                // 更新狀態
                document.getElementById('executionStatus').className = 'status-badge status-error';
                document.getElementById('executionStatus').innerHTML = '<i class="fas fa-times"></i> 錯誤';
                
                addSystemMessage(`❌ ${data.error}`);
                
                // 重新啟用執行按鈕，隱藏停止按鈕
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
                currentExecutionId = null;
            }
        });

        socket.on('error', function(data) {
            addSystemMessage(`❌ 錯誤: ${data.message}`);
        });

        socket.on('execution_stopped', function(data) {
            if (data.id === currentExecutionId) {
                isExecuting = false;
                
                // 更新狀態
                document.getElementById('executionStatus').className = 'status-badge status-error';
                document.getElementById('executionStatus').innerHTML = '<i class="fas fa-stop-circle"></i> 已停止';
                
                addSystemMessage(`⏹️ ${data.message}`);
                
                // 重新啟用執行按鈕，隱藏停止按鈕，恢復停止按鈕狀態
                document.getElementById('executeBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('stopBtn').innerHTML = '<i class="fas fa-stop"></i> 停止';
                document.getElementById('stopBtn').style.display = 'none';
                currentExecutionId = null;
            }
        });

        // UI 功能函數
        function updateConnectionStatus(text, className) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = text;
            statusEl.className = `badge ${className}`;
        }

        function addSystemMessage(message) {
            const container = document.getElementById('outputContainer');
            const line = document.createElement('div');
            line.className = 'output-line system';
            line.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }

        function addOutputLine(text, type) {
            const container = document.getElementById('outputContainer');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = text;
            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }

        function executeCommand() {
            const input = document.getElementById('userInput').value.trim();
            if (!input) {
                alert('請輸入指令');
                return;
            }
            
            if (isExecuting) {
                alert('系統正在執行中，請稍等...');
                return;
            }
            
            // 發送執行請求
            socket.emit('execute_command', { input: input });
            
            // 清空輸入框
            document.getElementById('userInput').value = '';
        }

        function stopExecution() {
            if (!isExecuting || !currentExecutionId) {
                alert('目前沒有正在執行的命令');
                return;
            }
            
            // 發送停止請求
            socket.emit('stop_execution', { id: currentExecutionId });
            
            // 立即禁用停止按鈕
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('stopBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';
            
            addSystemMessage('⏹️ 正在停止執行...');
        }

        function clearOutput() {
            const container = document.getElementById('outputContainer');
            container.innerHTML = '<div class="output-line system"><i class="fas fa-info-circle"></i> 輸出已清除</div>';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                executeCommand();
            }
        }

        // 頁面載入完成後聚焦輸入框
        window.addEventListener('load', function() {
            document.getElementById('userInput').focus();
        });
    </script>
</body>
</html> 